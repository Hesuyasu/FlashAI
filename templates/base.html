{% load static %} {% load pwa %}
<!DOCTYPE html>
<html lang="en">

<head>
    {% progressive_web_app_meta %}
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{% block title %}Dashboard{% endblock %}</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link rel="stylesheet" href="{% static 'css/custom.css' %}">
    <link rel="stylesheet" href="{% static 'css/base.css' %}?v=8">
    {% block extra_css %}{% endblock %}
</head>

<body>
    <!-- Comic-style hamburger toggle for mobile -->
    <button class="navbar-toggler comic-hamburger" id="sidebarToggle" type="button" aria-label="Toggle navigation">
        <span></span>
        <span></span>
        <span></span>
    </button>

    <div class="container-fluid">
        <div class="row">
            <div class="col-auto col-md-2 px-0 sidebar comic-sidebar" id="sidebar">
                <!-- Collapse toggle button -->
                <button class="sidebar-collapse-btn" id="sidebarCollapseBtn" type="button" aria-label="Toggle sidebar">
                    <i class="bi bi-chevron-left"></i>
                </button>
                <div class="ps-logo text-center comic-badge"><span>FlashAI</span></div>
                <nav class="nav flex-column">
                    <a class="nav-link {% if request.resolver_match.url_name == 'home' %}active{% endif %}"
                        href="{% url 'home' %}">
                        <i class="bi bi-house-fill"></i> Dashboard
                    </a>
                    <a class="nav-link {% if request.resolver_match.url_name == 'create_flashcard' %}active{% endif %}"
                        href="{% url 'create_flashcard' %}">
                        <i class="bi bi-file-earmark-plus-fill"></i> Create FlashCard
                    </a>
                    <a class="nav-link {% if request.resolver_match.url_name == 'flashcard_list' %}active{% endif %}"
                        href="{% url 'flashcard_list' %}">
                        <i class="bi bi-journal-text"></i> FlashCard List
                    </a>
                    <a class="nav-link {% if request.resolver_match.url_name == 'upload_pdf' %}active{% endif %}"
                        href="{% url 'upload_pdf' %}">
                        <i class="bi bi-file-earmark-pdf-fill"></i> Upload PDF
                    </a>
                    <a class="nav-link {% if request.resolver_match.url_name == 'study_flashcards' %}active{% endif %}"
                        href="{% url 'study_flashcards' %}">
                        <i class="bi bi-file-earmark-pdf-fill"></i> Study Mode
                    </a>
                </nav>
                <form method="post" action="{% url 'account_logout' %}" class="logout-form">
                    {% csrf_token %}
                    <button type="submit" class="nav-link text-start" style="background:none;border:none;width:100%;">
                        <i class="bi bi-box-arrow-right"></i> Logout
                    </button>
                </form>
            </div>

            <div class="col py-3">
                {% block content %}
                <h2 class="mb-4 comic-heading"><span>Dashboard</span></h2>

                <div class="row justify-content-center g-4">
                    <div class="col-12 col-md-6 col-lg-4">
                        <div class="dashboard-stat flashcard-total-stat comic-panel text-center">
                            <h3 id="flashcard-count">{{ flashcard_count }}</h3>
                            <p class="mb-0 fw-bold total-label">Total FlashCards</p>
                        </div>
                    </div>
                </div>

                {% if request.resolver_match.url_name == 'home' %}
                <h3 class="mt-5 mb-3 comic-heading"><span>Recently Added</span></h3>
                <div class="row g-3 recent-flashcards">
                    {% for fc in recent_flashcards %}
                    <div class="col-md-6 col-lg-4">
                        <a href="{% url 'flashcard_update' fc.id %}" class="text-decoration-none">
                            <div class="flashcard-box comic-panel" style="cursor:pointer;">
                                <div class="recent-title">{{ fc.question|truncatechars:80 }}</div>
                                <div class="small text-muted mt-2">{{ fc.created_at|date:"Y-m-d H:i" }} Â· {{ fc.category.name }}</div>
                            </div>
                        </a>
                    </div>
                    {% empty %}
                    <div class="col-12"><p class="text-muted mb-0">No flashcards added yet.</p></div>
                    {% endfor %}
                </div>
                {% endif %}
                {% endblock %}
            </div>
        </div>
    </div>

    <script>
        setInterval(() => {
            fetch("{% url 'api_flashcard_count' %}")
                .then(res => res.json())
                .then(data => {
                    document.getElementById('flashcard-count').innerText = data.count;
                });
        }, 10000);

        // Comic sidebar toggle for mobile
        const toggleBtn = document.getElementById('sidebarToggle');
        const sidebar = document.getElementById('sidebar');
        const body = document.body;

        if (toggleBtn && sidebar) {
            toggleBtn.addEventListener('click', function() {
                sidebar.classList.toggle('show');
                toggleBtn.classList.toggle('active');
                body.classList.toggle('sidebar-open');
            });

            // Close sidebar when clicking outside on mobile
            document.addEventListener('click', function(e) {
                if (window.innerWidth <= 768 && 
                    sidebar.classList.contains('show') && 
                    !sidebar.contains(e.target) && 
                    !toggleBtn.contains(e.target)) {
                    sidebar.classList.remove('show');
                    toggleBtn.classList.remove('active');
                    body.classList.remove('sidebar-open');
                }
            });
        }

        // Sidebar collapse/expand toggle
        const collapseBtn = document.getElementById('sidebarCollapseBtn');
        if (collapseBtn && sidebar) {
            collapseBtn.addEventListener('click', function() {
                sidebar.classList.toggle('collapsed');
                // Save state to localStorage
                localStorage.setItem('sidebarCollapsed', sidebar.classList.contains('collapsed'));
            });

            // Restore saved state on page load
            const savedState = localStorage.getItem('sidebarCollapsed');
            if (savedState === 'true') {
                sidebar.classList.add('collapsed');
            }
        }
    </script>
    {% block extra_js %}{% endblock %}
</body>

</html>